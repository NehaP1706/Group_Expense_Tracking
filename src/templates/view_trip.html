<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ trip.trip_name }} - Trip Details</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem 4rem;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .card h2 {
            color: #333;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }
        .trip-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .trip-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 1rem;
            border-radius: 5px;
        }
        .destination-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        .destination-card h3 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        .route-section {
            background: #e3f2fd;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }
        .route-section h4 {
            color: #2196f3;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .flight-option {
            background: white;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 0.75rem;
            border-left: 3px solid #28a745;
        }
        .flight-option.daytime {
            border-left-color: #ffc107;
            background: #fffef0;
        }
        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .airline-name {
            font-weight: 600;
            color: #333;
            font-size: 1.05rem;
        }
        .flight-number {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
        }
        .time-info {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-top: 0.75rem;
        }
        .time-box {
            text-align: center;
        }
        .time-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        .time-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        .arrow {
            font-size: 1.5rem;
            color: #667eea;
        }
        .daytime-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .pathway-info {
            background: #e3f2fd;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        .empty-flights {
            text-align: center;
            padding: 2rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>‚úàÔ∏è {{ trip.trip_name }}</h1>
        <a href="{% if trip.group_name %}/groups?userId={{ userId }}{% else %}/profile?userId={{ userId }}{% endif %}">‚Üê Back</a>
    </div>

    <div class="container">
        <div class="trip-header">
            <h1>{{ trip.trip_name }}</h1>
            <p style="margin-top: 0.5rem; opacity: 0.9;">
                {% if trip.group_name %}Group Trip: {{ trip.group_name }}{% else %}Solo Trip{% endif %}
            </p>
            <div class="trip-stats">
                <div class="stat-box">
                    <div style="font-size: 0.9rem; opacity: 0.8;">Travel Class</div>
                    <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">
                        {{ trip.travel_class.title() }}
                    </div>
                </div>
                <div class="stat-box">
                    <div style="font-size: 0.9rem; opacity: 0.8;">Destinations</div>
                    <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">
                        {{ destinations|length }}
                    </div>
                </div>
                {% if pathway %}
                <div class="stat-box">
                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Cost</div>
                    <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">
                        ${{ pathway.total_cost|round(2) if pathway.total_cost else 'N/A' }}
                    </div>
                </div>
                {% if pathway.total_ways > 1 %}
                <div class="stat-box">
                    <div style="font-size: 0.9rem; opacity: 0.8;">Possible Routes</div>
                    <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">
                        {{ pathway.total_ways }}
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>

        {% if pathway and pathway.total_ways > 1 %}
        <div class="card">
            <div class="pathway-info">
                <h3 style="color: #2196f3; margin-bottom: 0.5rem;">üßÆ Route Analysis</h3>
                <p>Based on the Hamiltonian path algorithm, there are <strong>{{ pathway.total_ways }}</strong> different ways to visit all destinations. The route shown below is the optimal path.</p>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <h2>üó∫Ô∏è Itinerary</h2>
            <div id="tripItinerary">
                <p style="text-align: center; padding: 2rem; color: #666;">Loading flight details...</p>
            </div>
        </div>
    </div>

    <script>
        const tripId = {{ trip.trip_id }};
        const userId = "{{ userId }}";

        async function loadFlightDetails() {
            try {
                const response = await fetch(`/api/trips?userId=${userId}`);
                const trips = await response.json();
                
                const currentTrip = trips.find(t => t.trip_id === tripId);
                if (!currentTrip) {
                    document.getElementById('tripItinerary').innerHTML = 
                        '<p style="color: #e74c3c;">Trip not found</p>';
                    return;
                }

                const destinations = currentTrip.destinations || [];
                const pathwayData = currentTrip.optimal_pathway;
                
                // Parse the path sequence
                let pathIndices = [];
                if (pathwayData && pathwayData.path_sequence) {
                    try {
                        pathIndices = JSON.parse(pathwayData.path_sequence);
                    } catch (e) {
                        console.error('Error parsing path sequence:', e);
                    }
                }

                // If no path sequence, use order as-is
                if (pathIndices.length === 0) {
                    pathIndices = destinations.map((_, idx) => idx);
                }

                let html = '';

                for (let i = 0; i < pathIndices.length; i++) {
                    const destIdx = pathIndices[i];
                    const dest = destinations[destIdx];
                    
                    html += `
                        <div class="destination-card">
                            <h3>Stop ${i + 1}: ${dest.city}, ${dest.country}</h3>
                            ${dest.airport_code ? `<p style="color: #666;">Airport: ${dest.airport_code}</p>` : ''}
                            ${dest.arrival_date ? `
                                <p style="color: #666; margin-top: 0.5rem;">
                                    üìÖ Arrival: ${new Date(dest.arrival_date).toLocaleDateString('en-US', { 
                                        year: 'numeric', month: 'long', day: 'numeric' 
                                    })}
                                </p>
                            ` : ''}
                            ${dest.departure_date ? `
                                <p style="color: #666;">
                                    üìÖ Departure: ${new Date(dest.departure_date).toLocaleDateString('en-US', { 
                                        year: 'numeric', month: 'long', day: 'numeric' 
                                    })}
                                </p>
                            ` : ''}
                        </div>
                    `;

                    // Add flight information - including return flight to first city
                    const isLastCity = (i === pathIndices.length - 1);
                    const nextDestIdx = isLastCity ? pathIndices[0] : pathIndices[i + 1];
                    const nextDest = destinations[nextDestIdx];
                    
                    html += `
                        <div class="route-section">
                            <h4>‚úàÔ∏è Flight from ${dest.city} to ${nextDest.city} ${isLastCity ? '(Return Flight)' : ''}</h4>
                            <div id="flights-${i}" style="margin-top: 1rem;">
                                <p style="color: #666;">Loading flight options...</p>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('tripItinerary').innerHTML = html;

                // Now fetch and display actual flight options
                await loadFlightOptions(destinations, pathIndices);

            } catch (err) {
                console.error('Error loading trip details:', err);
                document.getElementById('tripItinerary').innerHTML = 
                    '<p style="color: #e74c3c;">Error loading trip details</p>';
            }
        }

        async function loadFlightOptions(destinations, pathIndices) {
            // Load flights including the return flight
            for (let i = 0; i < pathIndices.length; i++) {
                const destIdx = pathIndices[i];
                const isLastCity = (i === pathIndices.length - 1);
                const nextDestIdx = isLastCity ? pathIndices[0] : pathIndices[i + 1];
                const dest = destinations[destIdx];
                const nextDest = destinations[nextDestIdx];

                try {
                    // Make API call to get flight options
                    const response = await fetch('/api/trips/calculate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tripName: 'temp',
                            startDate: dest.departure_date || new Date().toISOString().split('T')[0],
                            destinations: [
                                {
                                    city: dest.city,
                                    country: dest.country,
                                    airport: dest.airport_code,
                                    days: 1
                                },
                                {
                                    city: nextDest.city,
                                    country: nextDest.country,
                                    airport: nextDest.airport_code,
                                    days: 1
                                }
                            ]
                        })
                    });

                    const result = await response.json();
                    
                    const flightsDiv = document.getElementById(`flights-${i}`);
                    
                    if (result.paths && result.paths.length > 0 && result.paths[0].flights.length > 0) {
                        const flightOptions = result.paths[0].flights[0].options || [];
                        
                        if (flightOptions.length === 0) {
                            flightsDiv.innerHTML = `
                                <div class="empty-flights">
                                    <p>No direct flights found between these airports.</p>
                                    <p style="font-size: 0.9rem; margin-top: 0.5rem; color: #999;">
                                        You may need connecting flights.
                                    </p>
                                </div>
                            `;
                        } else {
                            let flightsHtml = '';
                            flightOptions.forEach(flight => {
                                const isDaytime = flight.is_daytime;
                                flightsHtml += `
                                    <div class="flight-option ${isDaytime ? 'daytime' : ''}">
                                        <div class="flight-header">
                                            <span class="airline-name">
                                                ${flight.airline}
                                                ${isDaytime ? '<span class="daytime-badge">üåû Daytime</span>' : ''}
                                            </span>
                                            <span class="flight-number">${flight.flight_number || 'N/A'}</span>
                                        </div>
                                        <div class="time-info">
                                            <div class="time-box">
                                                <div class="time-label">Departure</div>
                                                <div class="time-value">${flight.departure_time_str}</div>
                                                <div class="time-label" style="margin-top: 0.25rem;">${flight.from_airport}</div>
                                            </div>
                                            <div class="arrow">‚Üí</div>
                                            <div class="time-box">
                                                <div class="time-label">Arrival</div>
                                                <div class="time-value">${flight.arrival_time_str}</div>
                                                <div class="time-label" style="margin-top: 0.25rem;">${flight.to_airport}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            flightsDiv.innerHTML = flightsHtml;
                        }
                    } else {
                        flightsDiv.innerHTML = `
                            <div class="empty-flights">
                                <p>Unable to fetch flight information at this time.</p>
                            </div>
                        `;
                    }
                } catch (err) {
                    console.error(`Error loading flights for segment ${i}:`, err);
                    document.getElementById(`flights-${i}`).innerHTML = `
                        <div class="empty-flights">
                            <p style="color: #e74c3c;">Error loading flights</p>
                        </div>
                    `;
                }
            }
        }

        // Load flight details when page loads
        loadFlightDetails();
    </script>
</body>
</html>