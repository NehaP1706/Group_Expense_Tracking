<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Trip - Expense Tracker</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
        }
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #333;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }
        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            margin-bottom: 1rem;
            z-index: 1;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 600;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            width: 100%;
            padding: 1rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1rem;
        }
        button:hover {
            background: #5568d3;
        }
        .destination-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .destination-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 0.75rem;
            position: relative;
        }
        .destination-item h4 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            width: auto;
            margin: 0;
        }
        .days-input {
            margin-top: 0.5rem;
        }
        .days-input label {
            font-size: 0.85rem;
            color: #666;
            display: block;
            margin-bottom: 0.25rem;
        }
        .days-input input {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        .info-box {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
            margin-bottom: 1rem;
        }
        .leaflet-control-geocoder {
            z-index: 1000;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #667eea;
        }
        .loading.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>‚úàÔ∏è {% if isSolo %}Plan Solo Trip{% else %}Plan Group Trip{% endif %}</h1>
        <a href="{% if isSolo %}/profile?userId={{ userId }}{% else %}/groups?userId={{ userId }}{% endif %}">‚Üê Back</a>
    </div>

    <div class="container">
        <!-- Map Section -->
        <div class="card">
            <h2>üó∫Ô∏è Select Destinations</h2>
            <div class="info-box">
                <strong>How to use:</strong> Click the search icon on the map or click anywhere to add destinations. First city = starting point (you'll return here at the end).
            </div>
            
            <div id="map"></div>
            <button onclick="addCurrentLocation()">üìç Add Current Selection</button>
        </div>

        <!-- Trip Details Section -->
        <div class="card">
            <h2>üìã Trip Details</h2>
            
            <div class="form-group">
                <label>Trip Name</label>
                <input type="text" id="tripName" placeholder="e.g., India Tour 2025" required>
            </div>

            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="startDate" required>
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Round Trip Journey:</strong> This is a round-trip. You'll start from the first city, visit all destinations, and return to where you started.
            </div>

            <h3 style="margin: 1.5rem 0 1rem; color: #333;">Selected Destinations</h3>
            <div class="destination-list" id="destinationList">
                <p style="color: #666; text-align: center; padding: 2rem;">No destinations added yet</p>
            </div>

            <div class="loading" id="loadingIndicator">
                <p>üîç Checking flight availability and calculating routes...</p>
                <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">This may take a minute...</p>
            </div>

            <button onclick="calculateTrip()">üöÄ Find All Possible Round-Trip Routes</button>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let destinations = [];
        let selectedLocation = null;
        let geocoder;
        let markerCount = 0;

        // Get user context from template
        const userId = "{{ userId }}";
        const isSolo = {{ 'true' if isSolo else 'false' }};
        const groupName = {% if groupName %}"{{ groupName }}"{% else %}null{% endif %};

        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            geocoder = L.Control.Geocoder.nominatim();
            
            const searchControl = L.Control.geocoder({
                geocoder: geocoder,
                position: 'topright',
                placeholder: 'Search for a city...',
                defaultMarkGeocode: false
            }).on('markgeocode', function(e) {
                const result = e.geocode;
                selectedLocation = {
                    lat: result.center.lat,
                    lng: result.center.lng,
                    name: result.name.split(',')[0],
                    formatted_address: result.html || result.name
                };
                map.setView(result.center, 10);
                
                if (window.tempMarker) {
                    map.removeLayer(window.tempMarker);
                }
                window.tempMarker = L.marker(result.center, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map).bindPopup('Click "Add Current Selection"').openPopup();
            }).addTo(map);
            
            map.on('click', function(e) {
                geocodeLatLng(e.latlng);
            });
            
            // Set default start date to today
            document.getElementById('startDate').valueAsDate = new Date();
        }

        function geocodeLatLng(latlng) {
            geocoder.reverse(latlng, map.options.crs.scale(map.getZoom()), function(results) {
                if (results.length > 0) {
                    const result = results[0];
                    const parts = result.name.split(',');
                    selectedLocation = {
                        lat: latlng.lat,
                        lng: latlng.lng,
                        name: parts[0].trim(),
                        formatted_address: result.name
                    };
                    
                    if (window.tempMarker) {
                        map.removeLayer(window.tempMarker);
                    }
                    window.tempMarker = L.marker(latlng, {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map).bindPopup(`<b>${selectedLocation.name}</b><br>Click "Add Current Selection"`).openPopup();
                }
            });
        }

        function addCurrentLocation() {
            if (!selectedLocation) {
                alert('Please search for or click on a location first');
                return;
            }

            const parts = selectedLocation.formatted_address.split(',');
            const city = selectedLocation.name;
            const country = parts.length > 1 ? parts[parts.length - 1].trim() : 'Unknown';

            destinations.push({
                city: city,
                country: country,
                latitude: selectedLocation.lat,
                longitude: selectedLocation.lng,
                days: 2  // Default 2 days
            });

            if (window.tempMarker) {
                map.removeLayer(window.tempMarker);
                window.tempMarker = null;
            }

            markerCount++;
            const marker = L.marker([selectedLocation.lat, selectedLocation.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${markerCount}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            marker.bindPopup(`<b>${markerCount}. ${city}</b>`).openPopup();
            markers.push(marker);

            updateDestinationList();
            selectedLocation = null;
        }

        function updateDestinationList() {
            const list = document.getElementById('destinationList');
            if (destinations.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No destinations added yet</p>';
                return;
            }

            list.innerHTML = destinations.map((dest, idx) => `
                <div class="destination-item">
                    <button class="remove-btn" onclick="removeDestination(${idx})">‚úï</button>
                    <h4>${idx + 1}. ${dest.city}, ${dest.country} ${idx === 0 ? '(Start/End)' : ''}</h4>
                    <p style="color: #666; font-size: 0.9rem;">
                        ${dest.latitude.toFixed(4)}, ${dest.longitude.toFixed(4)}
                    </p>
                    <div class="days-input">
                        <label>Days to spend in ${dest.city}:</label>
                        <input type="number" min="1" max="30" value="${dest.days}" 
                               onchange="updateDays(${idx}, this.value)">
                    </div>
                </div>
            `).join('');
        }

        function removeDestination(idx) {
            destinations.splice(idx, 1);
            if (markers[idx]) {
                map.removeLayer(markers[idx]);
            }
            markers.splice(idx, 1);
            markerCount--;
            
            markers.forEach((marker, i) => {
                marker.setIcon(L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${i + 1}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                }));
                marker.bindPopup(`<b>${i + 1}. ${destinations[i].city}</b>`);
            });
            
            updateDestinationList();
        }

        function updateDays(idx, value) {
            destinations[idx].days = parseInt(value) || 2;
        }

        async function calculateTrip() {
            const tripName = document.getElementById('tripName').value;
            const startDate = document.getElementById('startDate').value;
            
            if (!tripName) {
                alert('Please enter a trip name');
                return;
            }

            if (!startDate) {
                alert('Please select a start date');
                return;
            }

            if (destinations.length < 2) {
                alert('Please add at least 2 destinations');
                return;
            }

            const payload = {
                tripName: tripName,
                groupName: groupName,
                createdBy: userId,
                startDate: startDate,
                destinations: destinations
            };

            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.add('active');

            try {
                const response = await fetch('/api/trips/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                loadingIndicator.classList.remove('active');

                if (response.ok) {
                    const numPaths = result.num_paths;
                    
                    if (numPaths === 0) {
                        alert('‚ùå No valid round-trip routes found. There may not be direct flights between some cities or back to the starting city.');
                        return;
                    }
                    
                    // Now save the trip to database
                    await saveTrip(result);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                loadingIndicator.classList.remove('active');
                console.error(err);
                alert('Error calculating trip routes');
            }
        }

        async function saveTrip(routeData) {
            try {
                const tripName = document.getElementById('tripName').value;
                const startDate = document.getElementById('startDate').value;
                
                const payload = {
                    tripName: tripName,
                    groupName: groupName,
                    createdBy: userId,
                    startDate: startDate,
                    destinations: destinations,
                    routeData: routeData  // Include calculated routes
                };

                const response = await fetch('/api/trips/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    // Redirect to view trip
                    window.location.href = `/trip/${result.trip_id}?userId=${userId}`;
                } else {
                    alert('Error saving trip: ' + result.error);
                }
            } catch (err) {
                console.error(err);
                alert('Error saving trip to database');
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>